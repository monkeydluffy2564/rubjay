<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANKOKMUANG SCHOOL - บันทึกรายรับรายจ่าย</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Kanit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- html2canvas for exporting image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container" class="relative h-screen w-full max-w-md mx-auto bg-gray-50 flex flex-col">
        
        <div id="page-content" class="flex-grow overflow-y-auto no-scrollbar">

            <!-- ======================= DASHBOARD PAGE ======================= -->
            <div id="dashboard-page">
                <header class="p-4 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">สวัสดี,</h1>
                        <p class="text-gray-500">จัดการเงินของคุณได้เลย</p>
                    </div>
                    <button class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md">
                        <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=User" class="rounded-full" alt="User profile" />
                    </button>
                </header>
                <main class="p-4 space-y-6 pb-28">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-lg relative">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-blue-100 text-lg font-medium">ยอดคงเหลือทั้งหมด</span>
                        </div>
                        <p id="balance-amount" class="text-4xl font-bold tracking-tight">฿ 0.00</p>
                    </div>
                    <div class="flex space-x-4">
                        <div class="bg-white p-4 rounded-2xl shadow-md flex-1">
                            <div class="flex items-center">
                               <div class="w-2 h-8 rounded-full bg-green-500 mr-3"></div>
                               <div>
                                <p class="text-gray-500 font-medium">รายรับเดือนนี้</p>
                                <p id="monthly-income" class="text-xl font-semibold text-green-600">฿ 0.00</p>
                               </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-md flex-1">
                            <div class="flex items-center">
                               <div class="w-2 h-8 rounded-full bg-red-500 mr-3"></div>
                               <div>
                                <p class="text-gray-500 font-medium">รายจ่ายเดือนนี้</p>
                                <p id="monthly-expense" class="text-xl font-semibold text-red-600">฿ 0.00</p>
                               </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-2">รายการล่าสุด</h3>
                        <div id="transactions-list" class="divide-y divide-gray-100"></div>
                    </div>
                </main>
                <div class="fixed bottom-20 right-6 z-20">
                    <button id="add-fab" class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
            </div>

            <!-- ======================= ADD/EDIT TRANSACTION PAGE ======================= -->
            <div id="form-page" class="hidden">
                 <div class="flex flex-col h-full">
                    <header class="p-4 flex items-center bg-gray-50 sticky top-0 z-10">
                        <button class="btn-back p-2 rounded-full hover:bg-gray-200 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                        <h1 id="form-title" class="text-xl font-bold text-gray-800">เพิ่มรายการใหม่</h1>
                    </header>
                    <main class="flex-grow p-4 space-y-4 overflow-y-auto">
                        <div class="grid grid-cols-2 gap-2 bg-gray-200 p-1 rounded-xl">
                            <button id="btn-type-expense" class="py-2 rounded-lg font-semibold bg-white shadow">รายจ่าย</button>
                            <button id="btn-type-income" class="py-2 rounded-lg font-semibold text-gray-600">รายรับ</button>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">จำนวนเงิน</label>
                            <input id="form-amount" type="number" placeholder="0.00" class="w-full text-2xl font-bold p-3 mt-1 bg-white border border-gray-200 rounded-xl focus:outline-none focus:border-blue-500" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">รายการ</label>
                            <input id="form-description" type="text" placeholder="เช่น กาแฟ, ค่าเดินทาง" class="w-full bg-white border border-gray-200 rounded-xl p-4 mt-1 focus:outline-none focus:border-blue-500" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">ผู้รับเงิน / ผู้จ่ายเงิน</label>
                            <select id="form-payee" class="w-full bg-white border border-gray-200 rounded-xl p-4 mt-1 focus:outline-none focus:border-blue-500">
                                <!-- Payee options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">หมวดหมู่</label>
                            <select id="form-category" class="w-full bg-white border border-gray-200 rounded-xl p-4 mt-1 focus:outline-none focus:border-blue-500">
                                <option>อาหาร</option> <option>เดินทาง</option> <option>ช้อปปิ้ง</option> <option>เงินเดือน</option> <option>อื่นๆ</option>
                            </select>
                        </div>
                    </main>
                    <footer class="p-4 bg-white border-t">
                        <button id="btn-save-transaction" class="w-full bg-blue-500 text-white font-bold py-4 rounded-2xl hover:bg-blue-600">บันทึกรายการ</button>
                    </footer>
                </div>
            </div>

            <!-- ======================= REPORTS PAGE ======================= -->
            <div id="reports-page" class="hidden">
                 <header class="p-4 flex items-center bg-gray-50 sticky top-0 z-10"><h1 class="text-xl font-bold text-gray-800">สรุปและรายงาน</h1></header>
                 <main class="p-4 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-md text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-blue-400 mb-4"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <h2 class="text-lg font-bold mb-2">สร้างสลิปสรุป</h2>
                        <p class="text-gray-500 mb-6">เลือกรายการธุรกรรมเพื่อสร้างเป็นไฟล์รูปภาพ (PNG)</p>
                        <button id="btn-export" class="w-full bg-blue-500 text-white font-bold py-4 rounded-2xl hover:bg-blue-600">เลือกรายการเพื่อส่งออก</button>
                    </div>
                    <div id="overall-summary-container"></div>
                    <div id="monthly-summary-container"></div>
                </main>
            </div>

            <!-- ======================= SETTINGS PAGE ======================= -->
            <div id="settings-page" class="hidden">
                <header class="p-4 flex items-center bg-gray-50 sticky top-0 z-10"><h1 class="text-xl font-bold text-gray-800">ตั้งค่า</h1></header>
                <main class="p-4 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="font-semibold text-gray-700 mb-4">จัดการรายชื่อผู้รับ/จ่าย</h3>
                        <div class="mb-4">
                            <textarea id="new-payee-names" rows="5" placeholder="เพิ่มหลายรายชื่อ (คนละบรรทัด)" class="w-full bg-gray-100 border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-blue-500"></textarea>
                            <button id="btn-add-payee" class="w-full mt-2 bg-blue-500 text-white font-semibold py-3 rounded-xl hover:bg-blue-600">เพิ่มรายชื่อ</button>
                        </div>
                        <div id="payee-list" class="space-y-2">
                            <!-- Payee list will be rendered here -->
                        </div>
                    </div>
                </main>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t sticky bottom-0">
          <div class="flex justify-around p-2">
            <button data-page="dashboard-page" class="nav-btn flex flex-col items-center p-2 rounded-lg w-1/4 text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="text-xs mt-1">ภาพรวม</span></button>
            <button data-page="reports-page" class="nav-btn flex flex-col items-center p-2 rounded-lg w-1/4 text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span class="text-xs mt-1">รายงาน</span></button>
            <button data-page="settings-page" class="nav-btn flex flex-col items-center p-2 rounded-lg w-1/4 text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg><span class="text-xs mt-1">ตั้งค่า</span></button>
          </div>
        </nav>
    </div>

    <!-- Transaction Selection Modal -->
    <div id="selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm flex flex-col" style="height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg">เลือกรายการเพื่อส่งออก</h2>
                <button id="btn-close-selection-modal" class="p-1 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div id="selection-list" class="flex-grow overflow-y-auto -mx-6 px-6 divide-y"></div>
            <button id="btn-generate-slip" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl mt-6 hover:bg-blue-600">สร้างสลิป</button>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg">ตัวอย่างสลิป</h2>
                <button id="btn-close-export-modal" class="p-1 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="p-1">
                <div id="report-slip" class="bg-white p-0 overflow-hidden rounded-lg"></div>
            </div>
            <button id="btn-save-image" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl mt-6 hover:bg-green-600">บันทึกรูปภาพ</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJsk4l8I8uCYpJY8jZLAlRW1w2qLWN-2o",
            authDomain: "game24-69666.firebaseapp.com",
            projectId: "game24-69666",
            storageBucket: "game24-69666.appspot.com",
            messagingSenderId: "989271279576",
            appId: "1:989271279576:web:43115bbaeeae31160954ad",
            measurementId: "G-B1ZTE90SGG"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'expense-tracker-mkm';

        let allTransactions = [];
        let allPayees = [];
        let editingTransactionId = null;

        const pages = document.querySelectorAll('#page-content > div');
        const navButtons = document.querySelectorAll('.nav-btn');
        const transactionsListEl = document.getElementById('transactions-list');
        const balanceEl = document.getElementById('balance-amount');
        const monthlyIncomeEl = document.getElementById('monthly-income');
        const monthlyExpenseEl = document.getElementById('monthly-expense');
        const formPage = document.getElementById('form-page');
        const formTitle = document.getElementById('form-title');
        const formSaveButton = document.getElementById('btn-save-transaction');

        const categoryIcons = {
            'อาหาร': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>`,
            'เดินทาง': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M3 11V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v5"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M6 20v-3a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v3"/></svg>`,
            'ช้อปปิ้ง': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-500"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>`,
            'เงินเดือน': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            'อื่นๆ': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12 2H2v10l9.29 9.29a1 1 0 0 0 1.41 0l7-7a1 1 0 0 0 0-1.41L12 2z"/><path d="M7 7h.01"/></svg>`
        };

        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('hidden', page.id !== pageId));
            navButtons.forEach(btn => {
                btn.classList.toggle('text-blue-500', btn.dataset.page === pageId);
                btn.classList.toggle('text-gray-500', btn.dataset.page !== pageId);
            });
            if (pageId === 'reports-page') {
                renderMonthlySummary();
                renderOverallSummary();
            }
        }

        function renderDashboard() {
            transactionsListEl.innerHTML = '';
            if (allTransactions.length === 0) {
                transactionsListEl.innerHTML = `<div class="text-center py-8 text-gray-500"><p>ยังไม่มีรายการธุรกรรม</p></div>`;
            } else {
                const sorted = [...allTransactions].sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                sorted.slice(0, 5).forEach(tx => {
                    const isIncome = tx.type === 'income';
                    const item = document.createElement('div');
                    item.className = 'flex items-start py-4 group';
                    item.innerHTML = `
                        <div class="flex-grow flex items-start">
                             <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">${categoryIcons[tx.category] || categoryIcons['อื่นๆ']}</div>
                             <div>
                                <p class="font-semibold text-gray-800">${tx.description}</p>
                                <p class="text-sm text-gray-500">${tx.category}</p>
                             </div>
                        </div>
                        <div class="text-right mr-2">
                            <p class="font-semibold ${isIncome ? 'text-green-500' : 'text-red-500'}">
                                ${isIncome ? '+' : '-'} ฿${tx.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                            </p>
                        </div>
                        <div class="flex opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-id="${tx.id}" class="btn-edit text-gray-400 hover:text-blue-500 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button data-id="${tx.id}" class="btn-delete text-gray-400 hover:text-red-500 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `;
                    transactionsListEl.appendChild(item);
                });
            }

            const balance = allTransactions.reduce((acc, tx) => (tx.type === 'income' ? acc + tx.amount : acc - tx.amount), 0);
            const now = new Date();
            const monthlyIncome = allTransactions.filter(tx => tx.type === 'income' && tx.createdAt && new Date(tx.createdAt.toDate()).getMonth() === now.getMonth()).reduce((acc, tx) => acc + tx.amount, 0);
            const monthlyExpense = allTransactions.filter(tx => tx.type === 'expense' && tx.createdAt && new Date(tx.createdAt.toDate()).getMonth() === now.getMonth()).reduce((acc, tx) => acc + tx.amount, 0);
            
            balanceEl.textContent = `฿ ${balance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            monthlyIncomeEl.textContent = `฿ ${monthlyIncome.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            monthlyExpenseEl.textContent = `฿ ${monthlyExpense.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
        }

        function renderMonthlySummary() {
            const container = document.getElementById('monthly-summary-container');
            const now = new Date();
            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const currentMonthName = thaiMonths[now.getMonth()];
            const currentYear = now.getFullYear() + 543;

            const monthlyIncome = allTransactions.filter(tx => tx.type === 'income' && tx.createdAt && new Date(tx.createdAt.toDate()).getMonth() === now.getMonth()).reduce((acc, tx) => acc + tx.amount, 0);
            const monthlyExpense = allTransactions.filter(tx => tx.type === 'expense' && tx.createdAt && new Date(tx.createdAt.toDate()).getMonth() === now.getMonth()).reduce((acc, tx) => acc + tx.amount, 0);
            const net = monthlyIncome - monthlyExpense;

            container.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-md" id="monthly-summary-card">
                    <h3 class="font-bold text-lg text-gray-800 text-center mb-4">สรุปประจำเดือน ${currentMonthName} ${currentYear}</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><span class="text-gray-600">รายรับทั้งหมด</span><span class="font-semibold text-green-600">+ ${monthlyIncome.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-600">รายจ่ายทั้งหมด</span><span class="font-semibold text-red-600">- ${monthlyExpense.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                        <hr class="my-2 border-dashed"/>
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">คงเหลือสุทธิ</span><span class="font-bold ${net >= 0 ? 'text-blue-600' : 'text-red-600'}">${net.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                    </div>
                    <button id="btn-export-monthly" class="w-full mt-6 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600">ส่งออกเป็น JPG</button>
                </div>`;
            document.getElementById('btn-export-monthly').addEventListener('click', handleMonthlyExport);
        }

        function renderOverallSummary() {
            const container = document.getElementById('overall-summary-container');
            const totalIncome = allTransactions.filter(tx => tx.type === 'income').reduce((acc, tx) => acc + tx.amount, 0);
            const totalExpense = allTransactions.filter(tx => tx.type === 'expense').reduce((acc, tx) => acc + tx.amount, 0);
            const balance = totalIncome - totalExpense;

            container.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-md" id="overall-summary-card">
                    <h3 class="font-bold text-lg text-gray-800 text-center mb-4">สรุปภาพรวมทั้งหมด</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><span class="text-gray-600">รายรับทั้งหมด</span><span class="font-semibold text-green-600">+ ${totalIncome.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-600">รายจ่ายทั้งหมด</span><span class="font-semibold text-red-600">- ${totalExpense.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                        <hr class="my-2 border-dashed"/>
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">ยอดคงเหลือทั้งหมด</span><span class="font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${balance.toLocaleString('en-US', {minimumFractionDigits: 2})} บาท</span></div>
                    </div>
                    <button id="btn-export-overall" class="w-full mt-6 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600">ส่งออกเป็น JPG</button>
                </div>`;
            document.getElementById('btn-export-overall').addEventListener('click', handleOverallExport);
        }
        
        async function addTransaction(data) {
            await addDoc(collection(db, `artifacts/${appId}/public/data/transactions`), { ...data, createdAt: new Date() });
        }
        async function updateTransaction(id, data) {
            const docRef = doc(db, `artifacts/${appId}/public/data/transactions`, id);
            await updateDoc(docRef, data);
        }
        async function deleteTransaction(id) {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/transactions`, id));
        }

        async function addPayee(name) {
            await addDoc(collection(db, `artifacts/${appId}/public/data/payees`), { name, count: 0 });
        }
        async function deletePayee(id) {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/payees`, id));
        }
        async function incrementPayeeCount(payeeName) {
            const payee = allPayees.find(p => p.name === payeeName);
            if (payee) {
                const newCount = (payee.count || 0) + 1;
                const docRef = doc(db, `artifacts/${appId}/public/data/payees`, payee.id);
                await updateDoc(docRef, { count: newCount });
            }
        }

        function renderPayeeList() {
            const listEl = document.getElementById('payee-list');
            const formSelectEl = document.getElementById('form-payee');
            listEl.innerHTML = '';
            formSelectEl.innerHTML = '<option value="">-- เลือกรายชื่อ --</option>';
            
            const sortedPayees = [...allPayees].sort((a, b) => (b.count || 0) - (a.count || 0));

            sortedPayees.forEach(payee => {
                const itemHtml = `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                        <span>${payee.name}</span>
                        <button data-id="${payee.id}" class="btn-delete-payee text-gray-400 hover:text-red-500 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>`;
                listEl.insertAdjacentHTML('beforeend', itemHtml);
                formSelectEl.insertAdjacentHTML('beforeend', `<option value="${payee.name}">${payee.name}</option>`);
            });
        }

        function prepareFormForAdd() {
            editingTransactionId = null;
            formTitle.textContent = 'เพิ่มรายการใหม่';
            formSaveButton.textContent = 'บันทึกรายการ';
            document.getElementById('form-amount').value = '';
            document.getElementById('form-description').value = '';
            document.getElementById('form-payee').value = '';
            document.getElementById('form-category').value = 'อื่นๆ';
            showPage('form-page');
        }

        function prepareFormForEdit(txId) {
            const tx = allTransactions.find(t => t.id === txId);
            if (!tx) return;
            editingTransactionId = txId;
            formTitle.textContent = 'แก้ไขรายการ';
            formSaveButton.textContent = 'บันทึกการแก้ไข';
            document.getElementById('form-amount').value = tx.amount;
            document.getElementById('form-description').value = tx.description;
            document.getElementById('form-payee').value = tx.payee;
            document.getElementById('form-category').value = tx.category;
            const btnExpense = document.getElementById('btn-type-expense');
            const btnIncome = document.getElementById('btn-type-income');
            const isExpense = tx.type === 'expense';
            btnExpense.classList.toggle('bg-white', isExpense);
            btnExpense.classList.toggle('shadow', isExpense);
            btnExpense.classList.toggle('text-gray-600', !isExpense);
            btnIncome.classList.toggle('bg-white', !isExpense);
            btnIncome.classList.toggle('shadow', !isExpense);
            btnIncome.classList.toggle('text-gray-600', isExpense);
            showPage('form-page');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await signInAnonymously(auth);
            onSnapshot(collection(db, `artifacts/${appId}/public/data/transactions`), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                if (document.getElementById('reports-page').offsetParent !== null) {
                    renderMonthlySummary();
                    renderOverallSummary();
                }
            });
             onSnapshot(collection(db, `artifacts/${appId}/public/data/payees`), (snapshot) => {
                allPayees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPayeeList();
            });

            navButtons.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
            document.getElementById('add-fab').addEventListener('click', prepareFormForAdd);
            document.querySelectorAll('.btn-back').forEach(btn => btn.addEventListener('click', () => showPage('dashboard-page')));
            
            let type = 'expense';
            const btnExpense = document.getElementById('btn-type-expense');
            const btnIncome = document.getElementById('btn-type-income');
            btnExpense.addEventListener('click', () => {
                type = 'expense';
                btnExpense.classList.add('bg-white', 'shadow');
                btnExpense.classList.remove('text-gray-600');
                btnIncome.classList.remove('bg-white', 'shadow');
                btnIncome.classList.add('text-gray-600');
            });
            btnIncome.addEventListener('click', () => {
                type = 'income';
                btnIncome.classList.add('bg-white', 'shadow');
                btnIncome.classList.remove('text-gray-600');
                btnExpense.classList.remove('bg-white', 'shadow');
                btnExpense.classList.add('text-gray-600');
            });
            
            formSaveButton.addEventListener('click', () => {
                const data = { type, amount: parseFloat(document.getElementById('form-amount').value) || 0, description: document.getElementById('form-description').value, payee: document.getElementById('form-payee').value, category: document.getElementById('form-category').value };
                if (data.amount > 0 && data.description && data.payee) {
                    if (editingTransactionId) {
                        updateTransaction(editingTransactionId, data);
                    } else {
                        addTransaction(data);
                    }
                    incrementPayeeCount(data.payee);
                    showPage('dashboard-page');
                }
            });
            
            document.getElementById('page-content').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-delete');
                if (deleteBtn) { deleteTransaction(deleteBtn.dataset.id); return; }
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) { prepareFormForEdit(editBtn.dataset.id); }
            });

             document.getElementById('btn-add-payee').addEventListener('click', () => {
                const textarea = document.getElementById('new-payee-names');
                const names = textarea.value.split('\n').map(name => name.trim()).filter(name => name);
                if (names.length > 0) {
                    names.forEach(name => addPayee(name));
                    textarea.value = '';
                }
            });

            document.getElementById('payee-list').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-delete-payee');
                if (deleteBtn) {
                    deletePayee(deleteBtn.dataset.id);
                }
            });

            const selectionModal = document.getElementById('selection-modal');
            const exportModal = document.getElementById('export-modal');
            
            document.getElementById('btn-export').addEventListener('click', () => {
                const listEl = document.getElementById('selection-list');
                listEl.innerHTML = '';
                [...allTransactions].sort((a,b) => b.createdAt.seconds - a.createdAt.seconds).forEach(tx => {
                    listEl.insertAdjacentHTML('beforeend', `<label class="flex items-center p-4 cursor-pointer hover:bg-gray-50"><input type="checkbox" data-id="${tx.id}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><div class="ml-4 flex-grow"><p class="font-semibold text-gray-800">${tx.description}</p><p class="text-sm text-gray-500">${new Date(tx.createdAt.toDate()).toLocaleDateString('th-TH')}</p></div><span class="font-semibold ${tx.type === 'income' ? 'text-green-500' : 'text-red-500'}">${tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></label>`);
                });
                selectionModal.classList.remove('hidden');
            });
            
            document.getElementById('btn-close-selection-modal').addEventListener('click', () => selectionModal.classList.add('hidden'));
            document.getElementById('btn-close-export-modal').addEventListener('click', () => exportModal.classList.add('hidden'));

            document.getElementById('btn-generate-slip').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('#selection-list input:checked')).map(input => input.dataset.id);
                const selectedTxs = allTransactions.filter(tx => selectedIds.includes(tx.id));
                if (selectedTxs.length > 0) {
                    renderSlip(selectedTxs);
                    selectionModal.classList.add('hidden');
                    exportModal.classList.remove('hidden');
                } else {
                    alert('กรุณาเลือกอย่างน้อย 1 รายการ');
                }
            });
            
            document.getElementById('btn-save-image').addEventListener('click', handleExport);
        });
        
        function renderSlip(selectedTransactions) {
            const slipContainer = document.getElementById('report-slip');
            const sortedSelected = [...selectedTransactions].sort((a,b) => a.createdAt.seconds - b.createdAt.seconds);
            const oldestSelected = sortedSelected[0];
            const latestSelected = sortedSelected[sortedSelected.length - 1];
            
            const transactionDate = new Date(latestSelected.createdAt.toDate());
            const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const formattedDate = `${transactionDate.getDate()} ${thaiMonths[transactionDate.getMonth()]} ${transactionDate.getFullYear() + 543}`;
            const formattedTime = transactionDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            
            const balanceBefore = allTransactions
                .filter(tx => tx.createdAt.seconds < oldestSelected.createdAt.seconds)
                .reduce((acc, tx) => (tx.type === 'income' ? acc + tx.amount : acc - tx.amount), 0);

            const selectedSum = selectedTransactions.reduce((acc, tx) => (tx.type === 'income' ? acc + tx.amount : acc - tx.amount), 0);
            const balanceAfter = balanceBefore + selectedSum;

            const transactionRows = selectedTransactions.map(tx => `<div class="grid grid-cols-5 gap-2 py-2 items-start font-medium"><span class="col-span-2 break-words text-gray-800 text-base">${tx.description}</span><span class="col-span-2 text-center text-gray-600 break-words">${tx.payee}</span><span class="col-span-1 text-right font-semibold text-base ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}">${tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span></div>`).join('');
            
            const successIconSVG = `<svg class="w-16 h-16 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;

            slipContainer.innerHTML = `<div class="bg-white rounded-lg shadow-md overflow-hidden"><div class="p-4 bg-gradient-to-br from-cyan-400 to-blue-500 text-white text-center"><h2 class="font-bold text-2xl">BANKOKMUANG SCHOOL</h2></div><div class="p-5"><div class="text-center mb-4 pb-4"><div class="flex justify-center items-center w-20 h-20 rounded-full bg-green-100 mb-3 mx-auto">${successIconSVG}</div><h3 class="font-bold text-xl text-green-600">ทำรายการสำเร็จ</h3><p class="text-base text-gray-600 font-semibold">${formattedDate} - ${formattedTime} น.</p></div><div class="space-y-2 text-base border-t border-b border-dashed py-4"><div class="text-center mb-4"><p class="text-sm text-gray-500">ยอดยกมา</p><p class="font-semibold text-lg text-gray-800">${balanceBefore.toLocaleString('en-US', { minimumFractionDigits: 2 })} บาท</p></div><div class="grid grid-cols-5 gap-2 font-bold text-gray-600 uppercase tracking-wider pb-2 text-sm"><span class="col-span-2">รายการ</span><span class="col-span-2 text-center">ผู้รับ/จ่าย</span><span class="col-span-1 text-right">จำนวน</span></div>${transactionRows}</div><div class="flex justify-between items-center font-bold text-lg pt-4"><span class="text-gray-800">ยอดคงเหลือทั้งหมด</span><span class="text-blue-600">${balanceAfter.toLocaleString('en-US', { minimumFractionDigits: 2 })} บาท</span></div></div></div>`;
        }
        
        function handleExport() {
            const element = document.getElementById('report-slip');
            if (element && window.html2canvas) {
                html2canvas(element, { scale: 3, useCORS: true, backgroundColor: null }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `report-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }
        }
        
        function handleMonthlyExport() {
            const element = document.getElementById('monthly-summary-card');
             if (element && window.html2canvas) {
                html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `monthly-summary-${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                });
            }
        }
        
        function handleOverallExport() {
            const element = document.getElementById('overall-summary-card');
             if (element && window.html2canvas) {
                html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `overall-summary-${Date.now()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                });
            }
        }
    </script>
</body>
</html>
